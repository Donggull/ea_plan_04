/**
 * React 19 DevTools Profiler í™œìš© ìœ í‹¸ë¦¬í‹°
 * ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ìµœì í™” ë„êµ¬
 */
import { Profiler, ProfilerOnRenderCallback, ReactNode, useState, useEffect, useMemo } from 'react'\n\n// ì„±ëŠ¥ ë©”íŠ¸ë¦­ íƒ€ì…\ninterface PerformanceMetric {\n  id: string\n  phase: 'mount' | 'update'\n  actualDuration: number\n  baseDuration: number\n  startTime: number\n  commitTime: number\n  interactions: Set<any>\n  timestamp: number\n}\n\n// ì„±ëŠ¥ í†µê³„\ninterface PerformanceStats {\n  totalRenders: number\n  averageRenderTime: number\n  slowestRender: number\n  fastestRender: number\n  mountTime: number\n  updateTime: number\n  lastRender: number\n}\n\n// ì„±ëŠ¥ ì„ê³„ê°’\nconst PERFORMANCE_THRESHOLDS = {\n  SLOW_RENDER: 16, // 16ms (60fps ê¸°ì¤€)\n  VERY_SLOW_RENDER: 100, // 100ms\n  WARNING_RENDER_COUNT: 10, // 10íšŒ ì´ìƒ ë Œë”ë§ ì‹œ ê²½ê³ \n}\n\n// ì„±ëŠ¥ ë°ì´í„° ì €ì¥ì†Œ\nclass PerformanceStore {\n  private static instance: PerformanceStore\n  private metrics: Map<string, PerformanceMetric[]> = new Map()\n  private stats: Map<string, PerformanceStats> = new Map()\n  private listeners: Map<string, Array<(stats: PerformanceStats) => void>> = new Map()\n\n  static getInstance(): PerformanceStore {\n    if (!this.instance) {\n      this.instance = new PerformanceStore()\n    }\n    return this.instance\n  }\n\n  addMetric(metric: PerformanceMetric) {\n    const { id } = metric\n    \n    if (!this.metrics.has(id)) {\n      this.metrics.set(id, [])\n    }\n    \n    const componentMetrics = this.metrics.get(id)!\n    componentMetrics.push(metric)\n    \n    // ìµœëŒ€ 100ê°œ ë©”íŠ¸ë¦­ë§Œ ì €ì¥ (ë©”ëª¨ë¦¬ ê´€ë¦¬)\n    if (componentMetrics.length > 100) {\n      componentMetrics.shift()\n    }\n    \n    this.updateStats(id)\n    this.notifyListeners(id)\n  }\n\n  private updateStats(id: string) {\n    const componentMetrics = this.metrics.get(id) || []\n    if (componentMetrics.length === 0) return\n\n    const renderTimes = componentMetrics.map(m => m.actualDuration)\n    const mountMetrics = componentMetrics.filter(m => m.phase === 'mount')\n    const updateMetrics = componentMetrics.filter(m => m.phase === 'update')\n\n    const stats: PerformanceStats = {\n      totalRenders: componentMetrics.length,\n      averageRenderTime: renderTimes.reduce((a, b) => a + b, 0) / renderTimes.length,\n      slowestRender: Math.max(...renderTimes),\n      fastestRender: Math.min(...renderTimes),\n      mountTime: mountMetrics.length > 0 ? mountMetrics[0].actualDuration : 0,\n      updateTime: updateMetrics.length > 0 ? \n        updateMetrics.reduce((a, b) => a + b.actualDuration, 0) / updateMetrics.length : 0,\n      lastRender: componentMetrics[componentMetrics.length - 1].actualDuration\n    }\n\n    this.stats.set(id, stats)\n  }\n\n  getStats(id: string): PerformanceStats | undefined {\n    return this.stats.get(id)\n  }\n\n  getAllStats(): Record<string, PerformanceStats> {\n    const result: Record<string, PerformanceStats> = {}\n    this.stats.forEach((stats, id) => {\n      result[id] = stats\n    })\n    return result\n  }\n\n  subscribe(id: string, callback: (stats: PerformanceStats) => void): () => void {\n    if (!this.listeners.has(id)) {\n      this.listeners.set(id, [])\n    }\n    \n    const componentListeners = this.listeners.get(id)!\n    componentListeners.push(callback)\n    \n    return () => {\n      const index = componentListeners.indexOf(callback)\n      if (index > -1) {\n        componentListeners.splice(index, 1)\n      }\n    }\n  }\n\n  private notifyListeners(id: string) {\n    const listeners = this.listeners.get(id) || []\n    const stats = this.stats.get(id)\n    \n    if (stats) {\n      listeners.forEach(listener => listener(stats))\n    }\n  }\n\n  exportData(): string {\n    const data = {\n      timestamp: new Date().toISOString(),\n      metrics: Object.fromEntries(this.metrics),\n      stats: Object.fromEntries(this.stats)\n    }\n    \n    return JSON.stringify(data, null, 2)\n  }\n\n  clear() {\n    this.metrics.clear()\n    this.stats.clear()\n    this.listeners.clear()\n  }\n}\n\nconst performanceStore = PerformanceStore.getInstance()\n\n// React Profiler ë˜í¼ ì»´í¬ë„ŒíŠ¸\ninterface ReactProfilerProps {\n  id: string\n  children: ReactNode\n  enabled?: boolean\n  onSlowRender?: (id: string, duration: number) => void\n  threshold?: number\n}\n\nexport function ReactProfiler({\n  id,\n  children,\n  enabled = process.env.NODE_ENV === 'development',\n  onSlowRender,\n  threshold = PERFORMANCE_THRESHOLDS.SLOW_RENDER\n}: ReactProfilerProps) {\n  const onRender: ProfilerOnRenderCallback = (\n    id,\n    phase,\n    actualDuration,\n    baseDuration,\n    startTime,\n    commitTime,\n    interactions\n  ) => {\n    if (!enabled) return\n\n    const metric: PerformanceMetric = {\n      id,\n      phase,\n      actualDuration,\n      baseDuration,\n      startTime,\n      commitTime,\n      interactions,\n      timestamp: Date.now()\n    }\n\n    performanceStore.addMetric(metric)\n\n    // ëŠë¦° ë Œë”ë§ ê°ì§€\n    if (actualDuration > threshold) {\n      console.warn(\n        `Slow render detected in \"${id}\": ${actualDuration.toFixed(2)}ms (threshold: ${threshold}ms)`,\n        {\n          phase,\n          actualDuration,\n          baseDuration,\n          interactions: Array.from(interactions)\n        }\n      )\n      \n      onSlowRender?.(id, actualDuration)\n    }\n  }\n\n  if (!enabled) {\n    return <>{children}</>\n  }\n\n  return (\n    <Profiler id={id} onRender={onRender}>\n      {children}\n    </Profiler>\n  )\n}\n\n// ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í›…\nexport function usePerformanceStats(componentId: string) {\n  const [stats, setStats] = useState<PerformanceStats | undefined>()\n\n  useEffect(() => {\n    const unsubscribe = performanceStore.subscribe(componentId, setStats)\n    \n    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ\n    const initialStats = performanceStore.getStats(componentId)\n    if (initialStats) {\n      setStats(initialStats)\n    }\n\n    return unsubscribe\n  }, [componentId])\n\n  return stats\n}\n\n// ì„±ëŠ¥ ê²½ê³  ì‹œìŠ¤í…œ\nexport function usePerformanceWarnings(componentId: string, options: {\n  slowRenderThreshold?: number\n  maxRenderCount?: number\n} = {}) {\n  const {\n    slowRenderThreshold = PERFORMANCE_THRESHOLDS.SLOW_RENDER,\n    maxRenderCount = PERFORMANCE_THRESHOLDS.WARNING_RENDER_COUNT\n  } = options\n\n  const stats = usePerformanceStats(componentId)\n  \n  const warnings = useMemo(() => {\n    if (!stats) return []\n    \n    const warnings: string[] = []\n    \n    if (stats.averageRenderTime > slowRenderThreshold) {\n      warnings.push(`í‰ê·  ë Œë”ë§ ì‹œê°„ì´ ëŠë¦¼: ${stats.averageRenderTime.toFixed(2)}ms`)\n    }\n    \n    if (stats.slowestRender > PERFORMANCE_THRESHOLDS.VERY_SLOW_RENDER) {\n      warnings.push(`ë§¤ìš° ëŠë¦° ë Œë”ë§ ê°ì§€: ${stats.slowestRender.toFixed(2)}ms`)\n    }\n    \n    if (stats.totalRenders > maxRenderCount) {\n      warnings.push(`ê³¼ë„í•œ ë Œë”ë§: ${stats.totalRenders}íšŒ`)\n    }\n    \n    return warnings\n  }, [stats, slowRenderThreshold, maxRenderCount])\n\n  return {\n    stats,\n    warnings,\n    hasWarnings: warnings.length > 0\n  }\n}\n\n// ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸\nexport function PerformanceDashboard() {\n  const [allStats, setAllStats] = useState<Record<string, PerformanceStats>>({})\n  const [isVisible, setIsVisible] = useState(false)\n\n  useEffect(() => {\n    const updateStats = () => {\n      setAllStats(performanceStore.getAllStats())\n    }\n\n    const interval = setInterval(updateStats, 1000)\n    updateStats() // ì´ˆê¸° ë¡œë“œ\n\n    return () => clearInterval(interval)\n  }, [])\n\n  if (!isVisible || process.env.NODE_ENV !== 'development') {\n    return (\n      <button\n        onClick={() => setIsVisible(true)}\n        className=\"fixed bottom-4 right-4 bg-blue-500 text-white p-2 rounded-full shadow-lg z-50\"\n        title=\"ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ ì—´ê¸°\"\n      >\n        ğŸ“Š\n      </button>\n    )\n  }\n\n  const exportData = () => {\n    const data = performanceStore.exportData()\n    const blob = new Blob([data], { type: 'application/json' })\n    const url = URL.createObjectURL(blob)\n    const a = document.createElement('a')\n    a.href = url\n    a.download = `performance-data-${new Date().toISOString().split('T')[0]}.json`\n    a.click()\n    URL.revokeObjectURL(url)\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n      <div className=\"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h2 className=\"text-xl font-bold\">ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ</h2>\n          <div className=\"flex gap-2\">\n            <button\n              onClick={exportData}\n              className=\"bg-green-500 text-white px-3 py-1 rounded text-sm\"\n            >\n              ë‚´ë³´ë‚´ê¸°\n            </button>\n            <button\n              onClick={() => {\n                performanceStore.clear()\n                setAllStats({})\n              }}\n              className=\"bg-red-500 text-white px-3 py-1 rounded text-sm\"\n            >\n              ì´ˆê¸°í™”\n            </button>\n            <button\n              onClick={() => setIsVisible(false)}\n              className=\"bg-gray-500 text-white px-3 py-1 rounded text-sm\"\n            >\n              ë‹«ê¸°\n            </button>\n          </div>\n        </div>\n\n        <div className=\"space-y-4\">\n          {Object.entries(allStats).map(([componentId, stats]) => (\n            <div key={componentId} className=\"border rounded p-4\">\n              <h3 className=\"font-semibold mb-2\">{componentId}</h3>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                <div>\n                  <span className=\"text-gray-600\">ì´ ë Œë”ë§:</span>\n                  <span className=\"ml-2 font-mono\">{stats.totalRenders}</span>\n                </div>\n                <div>\n                  <span className=\"text-gray-600\">í‰ê·  ì‹œê°„:</span>\n                  <span className={`ml-2 font-mono ${\n                    stats.averageRenderTime > PERFORMANCE_THRESHOLDS.SLOW_RENDER\n                      ? 'text-red-600'\n                      : 'text-green-600'\n                  }`}>\n                    {stats.averageRenderTime.toFixed(2)}ms\n                  </span>\n                </div>\n                <div>\n                  <span className=\"text-gray-600\">ìµœëŒ€ ì‹œê°„:</span>\n                  <span className={`ml-2 font-mono ${\n                    stats.slowestRender > PERFORMANCE_THRESHOLDS.VERY_SLOW_RENDER\n                      ? 'text-red-600'\n                      : stats.slowestRender > PERFORMANCE_THRESHOLDS.SLOW_RENDER\n                      ? 'text-yellow-600'\n                      : 'text-green-600'\n                  }`}>\n                    {stats.slowestRender.toFixed(2)}ms\n                  </span>\n                </div>\n                <div>\n                  <span className=\"text-gray-600\">ë§ˆì§€ë§‰ ë Œë”ë§:</span>\n                  <span className=\"ml-2 font-mono\">\n                    {stats.lastRender.toFixed(2)}ms\n                  </span>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n\n        {Object.keys(allStats).length === 0 && (\n          <p className=\"text-center text-gray-500 py-8\">\n            ì„±ëŠ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.\n          </p>\n        )}\n      </div>\n    </div>\n  )\n}\n\n// HOC í˜•íƒœì˜ í”„ë¡œíŒŒì¼ëŸ¬\nexport function withProfiler<P extends object>(\n  Component: React.ComponentType<P>,\n  id?: string,\n  options?: Omit<ReactProfilerProps, 'children' | 'id'>\n) {\n  const WrappedComponent = (props: P) => {\n    const componentId = id || Component.displayName || Component.name || 'UnknownComponent'\n    \n    return (\n      <ReactProfiler id={componentId} {...options}>\n        <Component {...props} />\n      </ReactProfiler>\n    )\n  }\n\n  WrappedComponent.displayName = `withProfiler(${Component.displayName || Component.name})`\n\n  return WrappedComponent\n}\n\n// ì„±ëŠ¥ ìµœì í™” ì œì•ˆ ì‹œìŠ¤í…œ\nexport function usePerformanceRecommendations(componentId: string) {\n  const stats = usePerformanceStats(componentId)\n  \n  const recommendations = useMemo(() => {\n    if (!stats) return []\n    \n    const recommendations: string[] = []\n    \n    if (stats.averageRenderTime > PERFORMANCE_THRESHOLDS.SLOW_RENDER) {\n      recommendations.push('React.memo() ì‚¬ìš©ì„ ê³ ë ¤í•´ë³´ì„¸ìš”')\n      recommendations.push('useMemo() ë˜ëŠ” useCallback() ìœ¼ë¡œ ê°’ì„ ë©”ëª¨ì´ì œì´ì…˜í•˜ì„¸ìš”')\n    }\n    \n    if (stats.totalRenders > PERFORMANCE_THRESHOLDS.WARNING_RENDER_COUNT) {\n      recommendations.push('ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ì„ ë°©ì§€í•˜ì„¸ìš”')\n      recommendations.push('useStateì˜ í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”')\n    }\n    \n    if (stats.slowestRender > PERFORMANCE_THRESHOLDS.VERY_SLOW_RENDER) {\n      recommendations.push('ì»´í¬ë„ŒíŠ¸ë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì„¸ìš”')\n      recommendations.push('React.lazy()ë¡œ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…ì„ ê³ ë ¤í•˜ì„¸ìš”')\n    }\n    \n    return recommendations\n  }, [stats])\n\n  return recommendations\n}\n\nexport { performanceStore }"